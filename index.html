<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AI Finance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --text:#111; --bg:#fff; --accent:#2563eb;
      --pos:#16a34a; --neg:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:sans-serif; color:var(--text); background:var(--bg);}
    button, select, input{padding:4px 6px; font:inherit}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    .app{height:100vh; display:grid; grid-template-rows:auto 1fr;}
    .toolbar{display:flex; gap:10px; align-items:center; padding:8px 12px; border-bottom:1px solid var(--border); background:#fafafa}
    .toolbar .spacer{margin-left:auto; font-size:12px; color:var(--muted)}
    .main{display:grid; grid-template-columns: 2fr 1fr; min-height:0}

    .chart-wrap{min-width:0; min-height:0; display:flex; flex-direction:column}
    #chart{flex:1 1 auto; min-height:200px}

    .side{border-left:1px solid var(--border); display:flex; flex-direction:column; min-width:360px; min-height:0;}
    .tabs{display:flex; gap:6px; border-bottom:1px solid var(--border); background:#fafafa; align-items:center; padding:0 6px}
    .tab-btn{padding:10px 12px; border:0; background:transparent; cursor:pointer; border-bottom:2px solid transparent;}
    .tab-btn.active{border-color:var(--accent); font-weight:600}
    .tab-content{flex:1 1 auto; min-height:0; overflow:auto; padding:10px 12px}
    .news-controls, .bt-controls, .user-controls, .admin-controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .status{margin-left:auto; font-size:12px; color:var(--muted)}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:6px 8px; border-top:1px solid var(--border); text-align:left; vertical-align:top}
    td.num{text-align:right}
    .pill{font-weight:600}
    .pill.pos{color:var(--pos)} .pill.neg{color:var(--neg)} .pill.neu{color:var(--muted)}
    .bt-summary{margin-top:8px; font-size:13px; display:flex; gap:18px; flex-wrap:wrap}
    .btn-ghost{background:transparent; border:1px solid var(--border); border-radius:6px; padding:6px 10px; cursor:pointer}
  </style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <label for="symbol">Symbol:</label>
    <select id="symbol">
      <option>BTCUSDT</option>
      <option>ETHUSDT</option>
      <option>ADAUSDT</option>
    </select>
    <label for="tf">TF:</label>
    <select id="tf">
      <option value="1m">1m</option>
      <option value="5m">5m</option>
      <option value="15m">15m</option>
    </select>
    <button id="export">Export CSV</button>
    <span id="status" class="spacer">Idle</span>
  </div>

  <div class="main">
    <div class="chart-wrap">
      <div id="chart"></div>
    </div>

    <aside class="side">
      <div class="tabs">
        <button class="tab-btn active" data-tab="news">News</button>
        <button class="tab-btn" data-tab="bt">Backtest</button>
        <button class="tab-btn" data-tab="user">User</button>
        <button id="adminTab" class="tab-btn" data-tab="admin" style="display:none">Admin</button>
        <span id="side-status" class="status" style="margin-left:auto">Idle</span>
        <button id="logoutBtn" class="btn-ghost">Logout</button>
      </div>

      <!-- NEWS -->
      <div class="tab-content" id="tab-news" role="tabpanel">
        <div class="news-controls">
          <strong>Tin mới</strong>
          <input id="news-q" placeholder="tìm: btc, eth, rate..." />
          <label for="news-sym">Symbol:</label>
          <select id="news-sym">
            <option value="">(all)</option>
            <option>BTC</option>
            <option>ETH</option>
            <option>ADA</option>
          </select>
          <button id="news-load">Load</button>
          <span id="news-status" class="status">Idle</span>
        </div>
        <table id="news-table">
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Nguồn</th>
              <th>Tiêu đề</th>
              <th>Sentiment</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- BACKTEST -->
      <div class="tab-content" id="tab-bt" role="tabpanel" hidden>
        <div class="bt-controls">
          <strong>Backtest</strong>
          <label>Strategy
            <select id="bt-strategy">
              <option value="ma_cross">MA30 cross MA90</option>
              <option value="ma_cross_sent">MA30 cross MA90 + Sentiment≥0</option>
            </select>
          </label>
          <label>Limit
            <input id="bt-limit" type="number" value="1500" min="200" max="5000" style="width:90px">
          </label>
          <label>Fee
            <input id="bt-fee" type="number" step="0.0001" value="0.0005" style="width:90px">
          </label>
          <button id="bt-run">Run</button>
          <span id="bt-status" class="status">Idle</span>
        </div>

        <div id="bt-summary" class="bt-summary"></div>

        <div style="margin-top:8px; max-height:50vh; overflow:auto;">
          <table id="bt-trades">
            <thead>
              <tr>
                <th>Thời gian</th>
                <th>Action</th>
                <th class="num">Giá</th>
                <th class="num">PnL</th>
                <th class="num">Ghi chú</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- USER -->
      <div class="tab-content" id="tab-user" role="tabpanel" hidden>
        <div class="user-controls">
          <strong>Tài khoản</strong>
          <span id="me-email" class="status"></span>
        </div>
        <h4>Đổi mật khẩu</h4>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <input id="oldpw" type="password" placeholder="Old password">
          <input id="newpw" type="password" placeholder="New password (min 8)">
          <button id="btn-change-pw">Change</button>
          <span id="user-status" class="status">Idle</span>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="tab-content" id="tab-admin" role="tabpanel" hidden>
        <div class="admin-controls">
          <strong>Quản lý người dùng</strong>
          <button id="btn-reload-users">Reload</button>
          <span id="admin-status" class="status">Idle</span>
        </div>
        <div id="users"></div>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  "use strict";
  // ====== ENDPOINTS ======
  const AUTH       = "http://localhost:8080";  // auth-api
  const CANDLE_API = "http://localhost:8000";  // candle-api 
  const GATE       = "ws://localhost:8001/ws"; // market-gateway (xác thực qua token=?)
  const NEWS_API   = "http://localhost:8100";  // (không yêu cầu JWT)
  const BT_API     = "http://localhost:8300";  // (không yêu cầu JWT)

  // ====== AUTH HELPERS ======
  function access(){ return localStorage.getItem('access'); }
  function refresh(){ return localStorage.getItem('refresh'); }
  function setMe(obj){ localStorage.setItem('me', JSON.stringify(obj)); }
  function getMe(){ try{return JSON.parse(localStorage.getItem('me')||'{}')}catch{return {}} }
  function logout(){ localStorage.clear(); location.href='login.html'; }

  async function ensureLogin(){
    const t = access();
    if(!t){ location.href='login.html'; return; }
    try{
      const r = await fetch(AUTH+'/auth/me', { headers:{ Authorization:'Bearer '+t } });
      if(!r.ok) throw 0;
      window.currentUser = await r.json();
      setMe(window.currentUser);
      document.getElementById('me-email').textContent = window.currentUser.email + ' ('+window.currentUser.role+')';
      if(window.currentUser.role === 'ADMIN'){
        document.getElementById('adminTab').style.display='inline-block';
      }
    }catch(e){
      // thử refresh access token nếu có refresh token
      const rt = refresh();
      if(rt){
        try{
          const rr = await fetch(AUTH+'/auth/refresh', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({refresh_token: rt})
          });
          if(rr.ok){
            const data = await rr.json();
            localStorage.setItem('access', data.access_token);
            return ensureLogin(); // thử lại
          }
        }catch(_){}
      }
      logout();
    }
  }
  ensureLogin();

  // ====== UI ELs ======
  const symbolSel = document.getElementById('symbol');
  const tfSel = document.getElementById('tf');
  const statusEl = document.getElementById('status');
  const chartEl = document.getElementById('chart');
  const exportBtn = document.getElementById('export');
  const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
  const tabNews = document.getElementById('tab-news');
  const tabBt   = document.getElementById('tab-bt');
  const tabUser = document.getElementById('tab-user');
  const tabAdmin= document.getElementById('tab-admin');
  const logoutBtn = document.getElementById('logoutBtn');

  logoutBtn.addEventListener('click', logout);

  // ====== CHART ======
  const chart = LightweightCharts.createChart(chartEl, {
    layout:{ textColor:'#111', background:{type:'Solid', color:'#fff'} },
    rightPriceScale:{ borderVisible:false },
    timeScale:{ borderVisible:false, secondsVisible:true }
  });
  const series = chart.addCandlestickSeries();
  const sma30Series = chart.addLineSeries({ lineWidth:2, color:'blue' });
  const sma90Series = chart.addLineSeries({ lineWidth:2, color:'orange' });

  const ro = new ResizeObserver(() => {
    chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
  });
  ro.observe(chartEl);

  function setStatus(s){ statusEl.textContent = s; }
  function upsertCandle(c){
    if (candles.length && candles.at(-1).time === c.time){
      candles[candles.length-1] = c;
    } else {
      candles.push(c);
      if (candles.length > 5000) candles.shift();
    }
  }
  function calcSMA(data, period){
    const out=[];
    for (let i=period-1;i<data.length;i++){
      let sum=0;
      for (let j=0;j<period;j++) sum+=data[i-j].close;
      out.push({ time:data[i].time, value:sum/period });
    }
    return out;
  }

  function normalizeBarLike(obj){
    // Ưu tiên đọc các key phổ biến
    let t = obj.time ?? obj.ts ?? obj.t;
    let o = obj.open ?? obj.o;
    let h = obj.high ?? obj.h;
    let l = obj.low  ?? obj.l;
    let c = obj.close?? obj.c;

    // ép time về số giây
    t = Number(t);
    if (Number.isFinite(t)) {
      // nếu là milliseconds (>= 1e12) → đổi sang giây
      if (t >= 1e12) t = Math.floor(t / 1000);
    } else {
      return null; // bỏ qua bar xấu
    }

    // ép các giá trị về số
    o = Number(o); h = Number(h); l = Number(l); c = Number(c);
    if (![o,h,l,c].every(Number.isFinite)) return null;

    return { time: t, open: o, high: h, low: l, close: c };
  }
  
  async function myApiKlines(symbol, interval, limit=1000){
    const url = `${CANDLE_API}/candles?symbol=${symbol}&tf=${interval}&limit=${limit}`;
    const r = await fetch(url, { headers:{ Authorization:'Bearer '+access() }});
    const arr = await r.json();
    const mapped = arr.map(k => normalizeBarLike({ ts:k.ts, o:k.o, h:k.h, l:k.l, c:k.c }))
                      .filter(Boolean);
    // đảm bảo sort tăng dần theo time
    mapped.sort((a,b)=>a.time-b.time);
    return mapped;
  }

  let ws = null, candles = [];
  let session = 0;
  let wsReconnectTimer = null;
  let keepAliveTimer = null;
  let backoff = 1000;

  function clearTimers(){
    if (wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer=null; }
    if (keepAliveTimer){ clearInterval(keepAliveTimer); keepAliveTimer=null; }
  }

  function connectWS(symbol, interval, mySession){
    const t = access();
    const url = `${GATE}?symbol=${encodeURIComponent(symbol)}&tf=${encodeURIComponent(interval)}&token=${encodeURIComponent(t||'')}`;

    // k đóng socket hiện tại ngay lập tức
    // Chỉ dọn timer; socket cũ nếu còn sẽ tự đóng sau.
    clearTimers();

    const sock = new WebSocket(url);  // dùng biến cục bộ, chưa gán vào ws

    sock.onopen = () => {
      // Nếu phiên đã đổi, đóng chính "sock" này và rời
      if (mySession !== session) { try{ sock.close(1000,'stale'); }catch(_){} return; }

      // Tới đây là socket hợp lệ cho phiên hiện tại
      // Đóng ws cũ nếu nó đã OPEN; nếu đang CONNECTING thì cứ để nó tự chết
      if (ws && ws !== sock && ws.readyState === 1) { try{ ws.close(1000,'switch'); }catch(_){} }

      ws = sock; // chính thức dùng socket mới
      setStatus('WS connected');
      backoff = 1000;

      // keepalive app-level (nếu gateway cần)
      keepAliveTimer = setInterval(() => {
        if (mySession !== session || !ws || ws.readyState !== 1) return;
        try { ws.send(JSON.stringify({type:'ping'})); } catch(_) {}
      }, 25000);
    };

    sock.onmessage = (ev) => {
      if (mySession !== session || sock !== ws) return; // chỉ xử lý nếu là socket hiện tại & đúng phiên
      let m; try{ m = JSON.parse(ev.data); }catch{ return; }
      if (m.type === 'ping'){ try{ ws.send(JSON.stringify({type:'pong'})); }catch(_){} return; }
      if (m.symbol && m.symbol !== symbolSel.value) return; // lọc sai symbol (nếu gateway gửi kèm)

      const c = normalizeBarLike(m);
      if (!c) return;
      series.update(c); upsertCandle(c);
      const s30=calcSMA(candles,30).slice(-1)[0]; if(s30) sma30Series.update(s30);
      const s90=calcSMA(candles,90).slice(-1)[0]; if(s90) sma90Series.update(s90);
    };

    sock.onclose = (ev) => {
      // Chỉ reconnect nếu "sock" này vẫn là socket hiện tại & đúng phiên
      if (keepAliveTimer){ clearInterval(keepAliveTimer); keepAliveTimer=null; }
      if (mySession !== session || sock !== ws) return;

      setStatus(`WS disconnected (${ev.code}) ${ev.reason||''} – reconnecting…`);
      wsReconnectTimer = setTimeout(() => {
        connectWS(symbol, interval, mySession);
        backoff = Math.min(Math.floor(backoff * 1.7), 15000);
      }, backoff);
    };

    sock.onerror = () => { /* để onclose quyết định reconnect nếu cần */ };
  }


  async function load(symbol, interval){
    const mySession = ++session;
    setStatus('Loading history…');

    // Dọn timer; KHÔNG ép close ws nếu đang CONNECTING
    clearTimers();

    // reset dữ liệu chart
    candles = [];
    series.setData([]); sma30Series.setData([]); sma90Series.setData([]);

    try{
      const hist = await myApiKlines(symbol, interval, 1000);
      if (mySession !== session) return;
      candles = hist;
      series.setData(candles);
      sma30Series.setData(calcSMA(candles,30));
      sma90Series.setData(calcSMA(candles,90));
      setStatus('History loaded. Connecting WS…');
      connectWS(symbol, interval, mySession);
    }catch(e){
      if (e?.name === 'AbortError') return;
      setStatus('Load failed'); console.error(e);
    }
  }

  symbolSel.addEventListener('change', ()=>load(symbolSel.value, tfSel.value));
  tfSel.addEventListener('change', ()=>load(symbolSel.value, tfSel.value));
  exportBtn.addEventListener('click', ()=>{
    if(!candles.length){alert("Chưa có dữ liệu"); return;}
    const lines=["time,open,high,low,close"];
    candles.forEach(c=> lines.push([c.time,c.open,c.high,c.low,c.close].join(",")));
    const blob=new Blob([lines.join("\n")],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`${symbolSel.value}_${tfSel.value}.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  // ====== Tabs ======
  function showTab(name){
    tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    tabNews.hidden  = name!=='news';
    tabBt.hidden    = name!=='bt';
    tabUser.hidden  = name!=='user';
    tabAdmin.hidden = name!=='admin';
  }
  tabButtons.forEach(b=> b.addEventListener('click',()=>showTab(b.dataset.tab)));

  // ====== NEWS ======
  const newsBtn=document.getElementById('news-load');
  const newsQ=document.getElementById('news-q');
  const newsSym=document.getElementById('news-sym');
  const newsBody=document.querySelector('#news-table tbody');
  const newsStatus=document.getElementById('news-status');
  function pill(label){
    const cls=label==='positive'?'pos':label==='negative'?'neg':'neu';
    return `<span class="pill ${cls}">${label||'neutral'}</span>`;
  }
  function tsToLocal(ts){ return new Date(ts*1000).toLocaleString(); }
  async function loadNews(){
    newsStatus.textContent='Loading…';
    const params=new URLSearchParams({limit:'30'});
    if(newsQ.value.trim()) params.set('q', newsQ.value.trim());
    if(newsSym.value.trim()) params.set('symbol', newsSym.value.trim());
    const url=`${NEWS_API}/news?${params}`;
    const arr=await fetch(url).then(r=>r.json());
    newsBody.innerHTML=arr.map(it=>`
      <tr>
        <td>${it.published_at?tsToLocal(it.published_at):''}</td>
        <td>${it.source_name||''}</td>
        <td><a href="${it.url}" target="_blank" rel="noopener">${it.title}</a></td>
        <td>${pill(it.sentiment_label)}</td>
      </tr>`).join('');
    newsStatus.textContent=`Loaded ${arr.length} items`;
  }
  newsBtn.addEventListener('click', loadNews);
  loadNews();

  // ====== BACKTEST ======
  const runBtn=document.getElementById('bt-run');
  const stratEl=document.getElementById('bt-strategy');
  const limitEl=document.getElementById('bt-limit');
  const feeEl=document.getElementById('bt-fee');
  const btStatus=document.getElementById('bt-status');
  const sumEl=document.getElementById('bt-summary');
  const tbody=document.querySelector('#bt-trades tbody');
  function fmtPct(x){return (x*100).toFixed(2)+'%';}
  function fmtNum(x,d=2){return Number(x).toFixed(d);}
  async function runBacktest(){
    btStatus.textContent='Running…';
    const params=new URLSearchParams({
      symbol:symbolSel.value,
      tf:tfSel.value,
      rule:stratEl.value,
      limit:limitEl.value,
      fee:feeEl.value
    });
    const url=`${BT_API}/backtest?${params}`;
    const data=await fetch(url).then(r=>r.json());
    if(data.error){btStatus.textContent='Error'; return;}
    sumEl.innerHTML=`
      <div>Symbol:<b>${data.summary.symbol}</b> TF:<b>${data.summary.tf}</b> Rule:<b>${data.summary.rule}</b></div>
      <div>Số lệnh:<b>${data.summary.n_trades}</b> Win:<b>${data.summary.win}</b> Loss:<b>${data.summary.loss}</b> Winrate:<b>${fmtPct(data.summary.winrate)}</b></div>
      <div>Total Return:<b>${fmtPct(data.summary.total_return)}</b> Equity End:<b>${fmtNum(data.summary.equity_end,4)}</b> Sharpe:<b>${fmtNum(data.summary.sharpe_like,3)}</b></div>
    `;
    tbody.innerHTML=data.trades.map(it=>`
      <tr>
        <td>${tsToLocal(it.time)}</td>
        <td>${it.action}</td>
        <td class="num">${fmtNum(it.price)}</td>
        <td class="num">${it.pnl?fmtPct(it.pnl):''}</td>
        <td class="num">${it.sent_mean?('sent_mean='+fmtNum(it.sent_mean,3)):''}</td>
      </tr>`).join('');
    btStatus.textContent='Done';
  }
  runBtn.addEventListener('click', runBacktest);
  symbolSel.addEventListener('change', runBacktest);
  tfSel.addEventListener('change', runBacktest);

  // ====== USER tab ======
  const btnChangePw = document.getElementById('btn-change-pw');
  const oldpw = document.getElementById('oldpw');
  const newpw = document.getElementById('newpw');
  const userStatus = document.getElementById('user-status');

  btnChangePw.addEventListener('click', async ()=>{
    userStatus.textContent='Changing…';
    const r = await fetch(AUTH+'/auth/change-password', {
      method:'POST',
      headers:{'Content-Type':'application/json', Authorization:'Bearer '+access()},
      body: JSON.stringify({old_password: oldpw.value, new_password: newpw.value})
    });
    userStatus.textContent = r.ok ? 'Done' : 'Failed';
    if(r.ok){ oldpw.value=''; newpw.value=''; }
  });

  // ====== ADMIN tab ======
  const adminStatus = document.getElementById('admin-status');
  const usersDiv = document.getElementById('users');
  const btnReloadUsers = document.getElementById('btn-reload-users');

  async function loadUsers(page=1){
    adminStatus.textContent='Loading…';
    const r = await fetch(AUTH+`/admin/users?page=${page}`, { headers:{ Authorization:'Bearer '+access()} });
    if(!r.ok){ adminStatus.textContent='Load failed'; return; }
    const data = await r.json();
    usersDiv.innerHTML = data.map(u=>`
      <div style="border:1px solid var(--border); border-radius:8px; padding:8px; margin:6px 0">
        <div><b>${u.email}</b> — ${u.role} — ${u.status}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
          <button class="btn-ghost" onclick="setRole('${u.id}','ADMIN')">Make Admin</button>
          <button class="btn-ghost" onclick="setRole('${u.id}','USER')">Make User</button>
          <button class="btn-ghost" onclick="setStatus('${u.id}','ACTIVE')">Activate</button>
          <button class="btn-ghost" onclick="setStatus('${u.id}','DISABLED')">Disable</button>
          <button class="btn-ghost" onclick="resetPw('${u.id}')">Reset PW</button>
        </div>
      </div>
    `).join('');
    adminStatus.textContent='Done';
  }
  btnReloadUsers.addEventListener('click', ()=>loadUsers());

  // expose admin helpers to window so onclick can use
  window.setRole = async (id, role)=>{
    await fetch(AUTH+`/admin/users/${id}/role`,{
      method:'POST', headers:{'Content-Type':'application/json', Authorization:'Bearer '+access()},
      body: JSON.stringify({role})
    });
    loadUsers();
  };
  window.setStatus = async (id, status)=>{
    await fetch(AUTH+`/admin/users/${id}/status`,{
      method:'POST', headers:{'Content-Type':'application/json', Authorization:'Bearer '+access()},
      body: JSON.stringify({status})
    });
    loadUsers();
  };
  window.resetPw = async (id)=>{
    const r = await fetch(AUTH+`/admin/users/${id}/reset-password`,{
      method:'POST', headers:{ Authorization:'Bearer '+access() }
    });
    if(r.ok){
      const j = await r.json();
      alert('Temp password: '+j.temp_password);
    }else{
      alert('Reset failed');
    }
  };

  // ====== INITIAL LOAD ======
  load(symbolSel.value, tfSel.value);
  runBacktest();
  // nếu là admin, tự động tải danh sách người dùng
  if(getMe().role === 'ADMIN'){ loadUsers(); }

})();
</script>
</body>
</html>
